(()=>{const e="https://www.promptvault.link";chrome.runtime.onMessage.addListener((t,o,r)=>("OPEN_POPUP_EDITOR"===t.type?(console.log("Received data, saving to temp storage and opening popup:",t.payload),chrome.storage.local.set({tempChatData:t.payload}),chrome.windows.create({url:"popup.html",type:"popup",width:450,height:600})):"SAVE_FINAL_CHAT"===t.type?(async t=>{try{console.log("Attempting to get auth token...");const o=await chrome.cookies.get({url:e,name:"__session"});if(!o)return console.error("Authentication cookie not found. Opening login page for user."),chrome.tabs.create({url:`${e}/`}),{success:!1,message:"You are not logged in. Please sign in to PromptVault and try again."};const r=o.value,s=await fetch(`${e}/api/save-chat`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify(t)}),a=s.headers.get("content-type");if(!s.ok||!a||!a.includes("application/json"))return console.error("Authentication failed or server sent non-JSON response. Opening login page."),chrome.tabs.create({url:`${e}/`}),{success:!1,message:`Failed to save: ${s.statusText}`};const n=await s.json();return chrome.notifications.create({type:"basic",iconUrl:"icons/icon128.png",title:"PromptVault",message:`Chat "${n.prompt.title}" saved successfully!`}),chrome.tabs.query({url:`${e}/*`},e=>{e.forEach(e=>{e.id&&chrome.tabs.reload(e.id)})}),{success:!0,message:"Chat saved successfully!"}}catch(e){return console.error("An error occurred while saving to vault:",e),{success:!1,message:"An error occurred while saving to vault."}}})(t.payload).then(r):"GET_FOLDERS"===t.type&&(async()=>{try{const t=await chrome.cookies.get({url:e,name:"__session"});if(!t)return{success:!1,error:"Not authenticated. Please log in to PromptVault."};const o=t.value,r=await fetch(`${e}/api/folders`,{headers:{Authorization:`Bearer ${o}`}}),s=r.headers.get("content-type");return r.ok&&s&&s.includes("application/json")?{success:!0,data:await r.json()}:{success:!1,error:"Authentication failed. Please log in to PromptVault and try again."}}catch(e){return console.error("An error occurred while fetching folders:",e),{success:!1,message:"An error occurred while fetching folders.",error:e.message}}})().then(r),!0))})();